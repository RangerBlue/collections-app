<div class="collection-container">
  <header class="collection-header">
    <div class="header-content">
      <h1>My Collection</h1>
      <p class="subtitle">Browse through your unique collection</p>
    </div>
    <div class="header-actions">
      @if (selectedCollectionKey()) {
        <a routerLink="/collection/validate" [queryParams]="{collection: selectedCollectionKey()}" class="btn btn-check">Check Item</a>
        <a routerLink="/collection/add" [queryParams]="{collection: selectedCollectionKey()}" class="btn btn-add">+ Add Item</a>
      } @else {
        <a routerLink="/collection/validate" class="btn btn-check">Check Item</a>
        <a routerLink="/collection/add" class="btn btn-add">+ Add Item</a>
      }
    </div>
  </header>

  @if (error()) {
    <div class="error-container">
      <p class="error-message">{{ error() }}</p>
      <button class="btn btn-retry" (click)="retry()">Try Again</button>
    </div>
  }

  @if (isLoadingCollections()) {
    <div class="loading-container">
      <div class="spinner"></div>
      <p>Loading collections...</p>
    </div>
  }

  @if (!isLoadingCollections() && !error() && collections().length > 0) {
    <div class="collection-selector">
      <div class="collection-tabs">
        @for (collection of collections(); track collection.collectionKey) {
          <button
            class="collection-tab"
            [class.active]="selectedCollectionKey() === collection.collectionKey"
            (click)="selectCollection(collection.collectionKey)">
            {{ collection.collectionName }}
            @if (selectedCollectionKey() === collection.collectionKey && collectionTotalItems() > 0) {
              <span class="collection-count">{{ collectionTotalItems() }}</span>
            }
          </button>
        }
      </div>
    </div>

    <!-- Search Bar and Sort Controls -->
    <div class="search-container">
      <div class="search-input-wrapper">
        <input
          type="text"
          class="search-input"
          placeholder="Search items by name..."
          [ngModel]="searchQuery()"
          (ngModelChange)="onSearchInput($event)" />
        @if (searchQuery()) {
          <button class="search-clear-btn" (click)="clearSearch()">
            &times;
          </button>
        }
      </div>
      <button
        class="sort-btn"
        (click)="toggleSortDirection()"
        [title]="sortDirection() === 'asc' ? 'Oldest first' : 'Newest first'">
        @if (sortDirection() === 'desc') {
          Newest first ↓
        } @else {
          Oldest first ↑
        }
      </button>
    </div>

    @if (searchQuery()) {
      <div class="search-results-info">
        <span>Search results for "{{ searchQuery() }}" ({{ totalElements() }} found)</span>
        <button class="btn-link" (click)="clearSearch()">Clear search</button>
      </div>
    }
  }

  @if (!isLoadingCollections() && !error() && collections().length === 0) {
    <div class="empty-state">
      <h2>No collections yet</h2>
      <p>You don't have any collections. Create one by adding an item!</p>
    </div>
  }

  @if (isLoading()) {
    <div class="loading-container">
      <div class="spinner"></div>
      <p>Loading items...</p>
    </div>
  }

  @if (!isLoading() && !isLoadingCollections() && !error() && selectedCollectionKey()) {
    @if (items().length === 0) {
      <div class="empty-state">
        <h2>No items yet</h2>
        <p>This collection is empty. Start adding some items!</p>
      </div>
    } @else {
      <div class="collection-grid">
        @for (item of items(); track item.id) {
          <div class="collection-item" (click)="openItemDetail(item)">
            @if (item.signedUrl) {
              <div class="image-wrapper">
                <div class="image-spinner"></div>
                <img
                  [src]="item.signedUrl"
                  [alt]="item.name"
                  class="item-image"
                  (load)="$event.target.classList.add('loaded')"
                />
              </div>
            } @else {
              <div class="item-image-placeholder">
                <span>No Image</span>
              </div>
            }
            <div class="item-details">
              <h3 class="item-name">{{ item.name }}</h3>
            </div>
          </div>
        }
      </div>

      <div class="pagination">
        <button
          class="btn btn-pagination"
          (click)="previousPage()"
          [disabled]="!hasPrevious()">
          Previous
        </button>
        <span class="page-info">Page {{ currentPage() + 1 }} of {{ totalPages() }}</span>
        <button
          class="btn btn-pagination"
          (click)="nextPage()"
          [disabled]="!hasMore()">
          Next
        </button>
      </div>
    }
  }
</div>

<!-- Item Detail Modal -->
@if (selectedItem(); as item) {
  <div class="modal-overlay" (click)="closeItemDetail()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <button class="modal-close" (click)="closeItemDetail()">&times;</button>

      @if (isCropping()) {
        <!-- CROP MODE -->
        <div class="modal-header">
          <h2 class="modal-title">Crop Image</h2>
        </div>
        <div class="modal-body">
          <div class="crop-controls">
            <button
              class="btn btn-shape"
              [class.active]="cropShape() === 'rectangle'"
              (click)="cropShape.set('rectangle')">
              Rectangle
            </button>
            <button
              class="btn btn-shape"
              [class.active]="cropShape() === 'circle'"
              (click)="cropShape.set('circle')">
              Circle
            </button>
          </div>

          <div class="cropper-wrapper">
            <image-cropper
              [imageFile]="cropImageFile()"
              [maintainAspectRatio]="cropShape() === 'circle'"
              [aspectRatio]="1"
              [resizeToWidth]="800"
              [format]="cropShape() === 'circle' ? 'png' : 'jpeg'"
              [backgroundColor]="cropShape() === 'circle' ? 'transparent' : '#ffffff'"
              [roundCropper]="cropShape() === 'circle'"
              (imageCropped)="onImageCropped($event)"
              (imageLoaded)="onImageLoaded($event)"
              (cropperReady)="onCropperReady()"
              (loadImageFailed)="onLoadImageFailed()">
            </image-cropper>
          </div>

          <div class="crop-actions">
            <button class="btn btn-cancel" (click)="cancelImageChange()">Cancel</button>
            <button
              class="btn btn-primary"
              (click)="confirmImageCrop()"
              [disabled]="!croppedImageBlob()">
              Continue
            </button>
          </div>
        </div>
      } @else if (!isEditMode()) {
        <!-- VIEW MODE -->
        <div class="modal-header">
          @if (newImagePreview(); as preview) {
            <div class="image-preview-container">
              <img [src]="preview" [alt]="item.name" class="modal-image" [class.circle]="cropShape() === 'circle'" />
              <div class="image-preview-actions">
                <button class="btn btn-save-small" (click)="updateImage()" [disabled]="isUpdatingImage()">
                  @if (isUpdatingImage()) { Saving... } @else { Save Image }
                </button>
                <button class="btn btn-cancel-small" (click)="cancelImageChange()">Cancel</button>
              </div>
            </div>
          } @else {
            <div class="image-container">
              @if (item.image && item.image.signedUrl) {
                <img [src]="item.image.signedUrl" [alt]="item.name" class="modal-image" />
              }
              <button class="btn-change-image" (click)="selectNewImage()">Change Image</button>
            </div>
          }
          <h2 class="modal-title">{{ item.name }}</h2>
        </div>

        <div class="modal-body">
          <!-- Action Buttons -->
          <div class="modal-actions">
            <button class="btn btn-edit" (click)="enterEditMode()">Edit Item</button>
            <button class="btn btn-delete" (click)="deleteItem()">Delete</button>
          </div>

          <!-- Basic Info -->
          <div class="detail-section">
            <h3 class="section-title">Details</h3>
            <div class="detail-row">
              <span class="detail-label">Added:</span>
              <span class="detail-value">{{ item.createdAt | date:'medium' }}</span>
            </div>
            @if (item.updatedAt && item.updatedAt !== item.createdAt) {
              <div class="detail-row">
                <span class="detail-label">Updated:</span>
                <span class="detail-value">{{ item.updatedAt | date:'medium' }}</span>
              </div>
            }
            @if (item.description) {
              <div class="detail-row">
                <span class="detail-label">Description:</span>
                <span class="detail-value">{{ item.description }}</span>
              </div>
            }
          </div>

          <!-- Tags -->
          @if (item.tags && item.tags.length > 0) {
            <div class="detail-section">
              <h3 class="section-title">Tags</h3>
              <div class="tags-list">
                @for (tag of item.tags; track tag) {
                  <span class="tag-badge">{{ tag }}</span>
                }
              </div>
            </div>
          }

          <!-- Custom Tags -->
          @if (item.customTags && getCustomTagKeys(item.customTags).length > 0) {
            <div class="detail-section">
              <h3 class="section-title">Custom Tags</h3>
              <div class="custom-tags-grid">
                @for (entry of item.customTags | keyvalue; track entry.key) {
                  <div class="custom-tag-row">
                    <span class="custom-tag-key-box">{{ entry.key }}</span>
                    <span class="custom-tag-value-box">{{ entry.value }}</span>
                  </div>
                }
              </div>
            </div>
          }

          <!-- Image Analysis Confidence -->
          @if (item.visionMetadata?.overallConfidence; as confidence) {
            <div class="detail-section">
              <h3 class="section-title">Image Analysis</h3>
              <div class="detail-row">
                <span class="detail-label">Overall Confidence:</span>
                <span class="detail-value confidence-value">{{ confidence | percent:'1.0-0' }}</span>
              </div>
            </div>
          }

          <!-- Vision Data - Labels -->
          @if (item.visionMetadata?.labels; as labels) {
            @if (labels.length > 0) {
              <div class="detail-section">
                <h3 class="section-title">Detected Labels</h3>
                <div class="labels-list">
                  @for (label of labels; track label.description) {
                    <div class="label-item">
                      <span class="label-name">{{ label.description }}</span>
                      <span class="label-score">{{ label.score | percent:'1.0-0' }}</span>
                    </div>
                  }
                </div>
              </div>
            }
          }

          <!-- Vision Data - Text -->
          @if (item.visionMetadata?.textAnnotation; as textAnnotation) {
            @if (textAnnotation.fullText) {
              <div class="detail-section">
                <h3 class="section-title">Detected Text</h3>
                <p class="detected-text">{{ textAnnotation.fullText }}</p>
              </div>
            }
          }

          <!-- Vision Data - Logo -->
          @if (item.visionMetadata?.logoAnnotation; as logoAnnotation) {
            @if (logoAnnotation.description) {
              <div class="detail-section">
                <h3 class="section-title">Detected Logo</h3>
                <div class="logo-info">
                  <span class="logo-name">{{ logoAnnotation.description }}</span>
                  <span class="logo-score">{{ logoAnnotation.score | percent:'1.0-0' }}</span>
                </div>
              </div>
            }
          }

          <!-- Vision Data - Dominant Colors -->
          @if (item.visionMetadata?.dominantColors; as dominantColors) {
            @if (dominantColors.length > 0) {
              <div class="detail-section">
                <h3 class="section-title">Dominant Colors</h3>
                <div class="colors-list">
                  @for (color of dominantColors; track $index) {
                    <div
                      class="color-swatch"
                      [style.background-color]="'rgb(' + color.red + ',' + color.green + ',' + color.blue + ')'"
                      [title]="'RGB(' + color.red + ', ' + color.green + ', ' + color.blue + ') - ' + (color.pixelFraction * 100 | number:'1.1-1') + '%'">
                    </div>
                  }
                </div>
              </div>
            }
          }

          <!-- Image Info -->
          @if (item.image) {
            <div class="detail-section">
              <h3 class="section-title">Image Info</h3>
              @if (item.image.width && item.image.height) {
                <div class="detail-row">
                  <span class="detail-label">Dimensions:</span>
                  <span class="detail-value">{{ item.image.width }} x {{ item.image.height }}</span>
                </div>
              }
              @if (item.image.sizeBytes) {
                <div class="detail-row">
                  <span class="detail-label">Size:</span>
                  <span class="detail-value">{{ (item.image.sizeBytes / 1024) | number:'1.1-1' }} KB</span>
                </div>
              }
            </div>
          }
        </div>
      } @else {
        <!-- EDIT MODE -->
        <div class="modal-header">
          <h2 class="modal-title">Edit Item</h2>
        </div>

        <div class="modal-body">
          <div class="edit-form">
            <!-- Name -->
            <div class="form-group">
              <label class="form-label" for="editName">Name</label>
              <input
                type="text"
                id="editName"
                class="form-input"
                [ngModel]="editName()"
                (ngModelChange)="editName.set($event)"
                placeholder="Enter item name" />
            </div>

            <!-- Description -->
            <div class="form-group">
              <label class="form-label" for="editDescription">Description</label>
              <textarea
                id="editDescription"
                class="form-textarea"
                [ngModel]="editDescription()"
                (ngModelChange)="editDescription.set($event)"
                placeholder="Enter description"
                maxlength="100"
                rows="2"></textarea>
              <span class="char-count">{{ editDescription().length }}/100</span>
            </div>

            <!-- Custom Tags -->
            <div class="form-group">
              <label class="form-label">Custom Tags</label>
              <div class="custom-tags-edit">
                @for (entry of editCustomTags() | keyvalue; track entry.key) {
                  <div class="custom-tag-edit-row">
                    <span class="custom-tag-key-box">{{ entry.key }}</span>
                    <span class="custom-tag-value-box">{{ entry.value }}</span>
                    <button class="btn-remove-tag" (click)="removeCustomTag(entry.key)">&times;</button>
                  </div>
                }
              </div>

              <!-- Add new tag -->
              <div class="add-tag-row">
                <input
                  type="text"
                  class="form-input-small"
                  [ngModel]="newTagKey()"
                  (ngModelChange)="newTagKey.set($event)"
                  placeholder="Key" />
                <input
                  type="text"
                  class="form-input-small"
                  [ngModel]="newTagValue()"
                  (ngModelChange)="newTagValue.set($event)"
                  placeholder="Value" />
                <button class="btn btn-add-tag" (click)="addCustomTag()" [disabled]="!newTagKey() || !newTagValue()">Add</button>
              </div>
            </div>

            <!-- Form Actions -->
            <div class="form-actions">
              <button class="btn btn-cancel" (click)="cancelEdit()">Cancel</button>
              <button class="btn btn-save" (click)="saveChanges()" [disabled]="isSaving()">
                @if (isSaving()) { Saving... } @else { Save Changes }
              </button>
            </div>
          </div>
        </div>
      }
    </div>
  </div>
}
