<div class="collection-container">
  <header class="collection-header">
    <div class="header-content">
      <h1>My Collection</h1>
      <p class="subtitle">Browse through your unique collection</p>
    </div>
    <div class="header-actions">
      @if (selectedCollection()) {
        <a routerLink="/collection/validate" [queryParams]="{collection: selectedCollection()}" class="btn btn-check">Check Item</a>
        <a routerLink="/collection/add" [queryParams]="{collection: selectedCollection()}" class="btn btn-add">+ Add Item</a>
      } @else {
        <a routerLink="/collection/validate" class="btn btn-check">Check Item</a>
        <a routerLink="/collection/add" class="btn btn-add">+ Add Item</a>
      }
    </div>
  </header>

  @if (error()) {
    <div class="error-container">
      <p class="error-message">{{ error() }}</p>
      <button class="btn btn-retry" (click)="retry()">Try Again</button>
    </div>
  }

  @if (isLoadingCollections()) {
    <div class="loading-container">
      <div class="spinner"></div>
      <p>Loading collections...</p>
    </div>
  }

  @if (!isLoadingCollections() && !error() && collections().length > 0) {
    <div class="collection-selector">
      <div class="collection-tabs">
        @for (collection of collections(); track collection) {
          <button
            class="collection-tab"
            [class.active]="selectedCollection() === collection"
            (click)="selectCollection(collection)">
            {{ collection }}
          </button>
        }
      </div>
    </div>

    <!-- Search Bar -->
    <div class="search-container">
      <div class="search-input-wrapper">
        <input
          type="text"
          class="search-input"
          placeholder="Search items by name..."
          [ngModel]="searchQuery()"
          (ngModelChange)="onSearchInput($event)" />
        @if (searchQuery()) {
          <button class="search-clear-btn" (click)="clearSearch()">
            &times;
          </button>
        }
      </div>
    </div>

    @if (isSearchMode()) {
      <div class="search-results-info">
        <span>Search results for "{{ searchQuery() }}" ({{ items().length }} found)</span>
        <button class="btn-link" (click)="clearSearch()">Clear search</button>
      </div>
    }
  }

  @if (!isLoadingCollections() && !error() && collections().length === 0) {
    <div class="empty-state">
      <h2>No collections yet</h2>
      <p>You don't have any collections. Create one by adding an item!</p>
    </div>
  }

  @if (isLoading()) {
    <div class="loading-container">
      <div class="spinner"></div>
      <p>Loading items...</p>
    </div>
  }

  @if (!isLoading() && !isLoadingCollections() && !error() && selectedCollection()) {
    @if (items().length === 0) {
      <div class="empty-state">
        <h2>No items yet</h2>
        <p>This collection is empty. Start adding some items!</p>
      </div>
    } @else {
      <div class="collection-grid">
        @for (item of items(); track item.id) {
          <div class="collection-item" (click)="openItemDetail(item)">
            @if (item.image && item.image.signedUrl) {
              <img
                [src]="item.image.signedUrl"
                [alt]="item.name"
                class="item-image"
              />
            } @else {
              <div class="item-image-placeholder">
                <span>No Image</span>
              </div>
            }
            <div class="item-details">
              <h3 class="item-name">{{ item.name }}</h3>
              <p class="item-date">{{ item.createdAt | date:'mediumDate' }}</p>
            </div>
          </div>
        }
      </div>

      @if (!isSearchMode()) {
        <div class="pagination">
          <button
            class="btn btn-pagination"
            (click)="previousPage()"
            [disabled]="currentPage() === 0">
            Previous
          </button>
          <span class="page-info">Page {{ currentPage() + 1 }}</span>
          <button
            class="btn btn-pagination"
            (click)="nextPage()"
            [disabled]="!hasMore()">
            Next
          </button>
        </div>
      }
    }
  }
</div>

<!-- Item Detail Modal -->
@if (selectedItem(); as item) {
  <div class="modal-overlay" (click)="closeItemDetail()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <button class="modal-close" (click)="closeItemDetail()">&times;</button>

      <div class="modal-header">
        @if (item.image && item.image.signedUrl) {
          <img [src]="item.image.signedUrl" [alt]="item.name" class="modal-image" />
        }
        <h2 class="modal-title">{{ item.name }}</h2>
      </div>

      <div class="modal-body">
        <!-- Basic Info -->
        <div class="detail-section">
          <h3 class="section-title">Details</h3>
          <div class="detail-row">
            <span class="detail-label">Added:</span>
            <span class="detail-value">{{ item.createdAt | date:'medium' }}</span>
          </div>
          @if (item.updatedAt && item.updatedAt !== item.createdAt) {
            <div class="detail-row">
              <span class="detail-label">Updated:</span>
              <span class="detail-value">{{ item.updatedAt | date:'medium' }}</span>
            </div>
          }
          @if (item.description) {
            <div class="detail-row">
              <span class="detail-label">Description:</span>
              <span class="detail-value">{{ item.description }}</span>
            </div>
          }
        </div>

        <!-- Custom Tags -->
        @if (item.customTags && getCustomTagKeys(item.customTags).length > 0) {
          <div class="detail-section">
            <h3 class="section-title">Custom Tags</h3>
            <div class="custom-tags-grid">
              @for (entry of item.customTags | keyvalue; track entry.key) {
                <div class="custom-tag-row">
                  <span class="custom-tag-key">{{ entry.key }}</span>
                  <span class="custom-tag-value">{{ entry.value }}</span>
                </div>
              }
            </div>
          </div>
        }

        <!-- Vision Data - Labels -->
        @if (item.visionMetadata?.labels; as labels) {
          @if (labels.length > 0) {
            <div class="detail-section">
              <h3 class="section-title">Detected Labels</h3>
              <div class="labels-list">
                @for (label of labels; track label.description) {
                  <div class="label-item">
                    <span class="label-name">{{ label.description }}</span>
                    <span class="label-score">{{ label.score | percent:'1.0-0' }}</span>
                  </div>
                }
              </div>
            </div>
          }
        }

        <!-- Vision Data - Text -->
        @if (item.visionMetadata?.textAnnotation; as textAnnotation) {
          @if (textAnnotation.fullText) {
            <div class="detail-section">
              <h3 class="section-title">Detected Text</h3>
              <p class="detected-text">{{ textAnnotation.fullText }}</p>
            </div>
          }
        }

        <!-- Vision Data - Logo -->
        @if (item.visionMetadata?.logoAnnotation; as logoAnnotation) {
          @if (logoAnnotation.description) {
            <div class="detail-section">
              <h3 class="section-title">Detected Logo</h3>
              <div class="logo-info">
                <span class="logo-name">{{ logoAnnotation.description }}</span>
                <span class="logo-score">{{ logoAnnotation.score | percent:'1.0-0' }}</span>
              </div>
            </div>
          }
        }

        <!-- Vision Data - Dominant Colors -->
        @if (item.visionMetadata?.dominantColors; as dominantColors) {
          @if (dominantColors.length > 0) {
            <div class="detail-section">
              <h3 class="section-title">Dominant Colors</h3>
              <div class="colors-list">
                @for (color of dominantColors; track $index) {
                  <div
                    class="color-swatch"
                    [style.background-color]="'rgb(' + color.red + ',' + color.green + ',' + color.blue + ')'"
                    [title]="'RGB(' + color.red + ', ' + color.green + ', ' + color.blue + ') - ' + (color.pixelFraction * 100 | number:'1.1-1') + '%'">
                  </div>
                }
              </div>
            </div>
          }
        }

        <!-- Image Info -->
        @if (item.image) {
          <div class="detail-section">
            <h3 class="section-title">Image Info</h3>
            @if (item.image.width && item.image.height) {
              <div class="detail-row">
                <span class="detail-label">Dimensions:</span>
                <span class="detail-value">{{ item.image.width }} x {{ item.image.height }}</span>
              </div>
            }
            @if (item.image.sizeBytes) {
              <div class="detail-row">
                <span class="detail-label">Size:</span>
                <span class="detail-value">{{ (item.image.sizeBytes / 1024) | number:'1.1-1' }} KB</span>
              </div>
            }
          </div>
        }
      </div>
    </div>
  </div>
}
